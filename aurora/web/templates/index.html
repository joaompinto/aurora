<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Terminal Landing Page</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  body {
    background-color: black;
    color: #33FF33;
    font-family: monospace;
    margin: 0;
    padding: 20px;
    font-size: 16px;
  }
  .terminal {
    white-space: pre-wrap;
  }
  .cursor {
    display: inline-block;
    width: 10px;
    height: 1em;
    vertical-align: bottom;
    background-color: #33FF33;
    animation: blink 1s step-start infinite;
  }
  @keyframes blink {
    50% { background-color: transparent; }
  }
  .markdown-content {
    white-space: normal;
  }
  .tool-progress {
    color: #00BFFF;
    font-weight: bold;
    white-space: pre-wrap;
  }
</style>
</head>
<body>
<div class="terminal" id="terminal">
$ Welcome to Aurora Web App<br>
$ Your terminal-style landing page is ready.<br>
<span id="output"></span>
<span id="input-line"></span><span class="cursor"></span>
</div>
<script>
const terminal = document.getElementById('terminal');
const inputLine = document.getElementById('input-line');
const output = document.getElementById('output');

let command = '';

function appendToTerminal(text) {
  const line = document.createElement('div');
  line.textContent = text;
  terminal.insertBefore(line, output);
}

function appendOutput(content, cssClass = '') {
  let html = '';
  if (typeof content === 'string') {
    html = marked.parse(content);
  } else {
    html = '<pre>' + JSON.stringify(content, null, 2) + '</pre>';
  }
  const container = document.createElement('div');
  container.className = 'markdown-content ' + cssClass;
  container.innerHTML = html;
  terminal.insertBefore(container, output);
}

document.addEventListener('keydown', function(event) {
  if (event.key === 'Backspace') {
    command = command.slice(0, -1);
  } else if (event.key === 'Enter') {
    appendToTerminal('$ ' + command);
    sendCommandStream(command);
    command = '';
  } else if (event.key.length === 1) {
    command += event.key;
  }
  inputLine.textContent = '$ ' + command;
});

async function sendCommandStream(cmd) {
  const response = await fetch('/execute_stream', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ input: cmd })
  });

  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  let buffer = '';

  while(true) {
    const { done, value } = await reader.read();
    if(done) break;
    buffer += decoder.decode(value, {stream:true});

    let parts = buffer.split('\n\n');
    buffer = parts.pop();

    for(const part of parts) {
      if(part.startsWith('data: ')) {
        const jsonStr = part.slice(6);
        try {
          const data = JSON.parse(jsonStr);
          console.log('[WebClient] SSE event received:', data); // Log all SSE events
          if(data.type === 'content' && data.content) {
            appendOutput(data.content);
          } else if(data.type === 'tool_progress') {
            console.debug('[WebClient] Tool progress event:', data.progress); // Debug log
            const progress = data.progress;
            let msg = `ðŸ”§ <b>[Tool ${progress.tool}]</b> <b>${progress.event.toUpperCase()}</b>`;
            if(progress.event === 'start') {
              msg += `<br>Args: <code>${JSON.stringify(progress.args, null, 2)}</code>`;
            } else if(progress.event === 'finish') {
              if(progress.error) {
                msg += `<br>Error: <code>${progress.error}</code>`;
              } else {
                msg += `<br>Result: <code>${JSON.stringify(progress.result, null, 2)}</code>`;
              }
            } else {
              msg += `<br>Data: <code>${JSON.stringify(progress, null, 2)}</code>`;
            }
            appendOutput(msg, 'tool-progress');
          } else if(data.error) {
            appendOutput('Error: ' + data.error);
          }
        } catch(e) {
          console.error('Error parsing SSE data', e);
        }
      }
    }
  }
}
</script>
</body>
</html>
